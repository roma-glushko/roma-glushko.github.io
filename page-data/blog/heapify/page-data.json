{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/heapify/","result":{"data":{"markdownRemark":{"html":"<p>When you have a sequence of candidates to process, then you build a queue to organize them. In the classical queue, the time of adding an item to the queue defines when it's going to be processed.</p>\n<p>What if we need to change this principle and use some <strong>relative importance score</strong> to determine the item processing sequence?</p>\n<p>Well, then we would reinvent <del>bicycle</del> the priority queue.</p>\n<p>\n\t\t<video\n\t\t\tsrc=https://media.giphy.com/media/3orif1K6QR54NlWzLO/giphy.mp4\n\t\t\twidth=\"100%\"\n\t\t\theight=\"auto\"\n\t\t\tpreload=\"auto\"\n\t\t\tmuted=\"true\"\n\t\t\ttitle=\"Priority\"\n\t\t\tautoplay\n\t\t\tplaysinline\n\t\t\tcontrols\n\t\t\tloop\n\t\t></video>\n\t</p>\n<p><strong>The priority queue or heap</strong> is a data structure that efficiently allows the retrieval of the next queued item with min or max importance score.</p>\n<h2 id=\"nearly-complete-binary-tree\" style=\"position:relative;\"><a href=\"#nearly-complete-binary-tree\" aria-label=\"nearly complete binary tree permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Nearly Complete Binary Tree</h2>\n<p>The heap can be represented as an array or a list that is visualized as a nearly complete binary tree:</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 28.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAz0lEQVQY04VPy26DMBD0/39ZDhwiopA0DYlSlQhMCthr09jeRwVIqK1UdU6zo52dHSV/w49j1/fM/EtfFbVKKaXBGEQEAGstALzfbvs8B+eMMdbaEIKfsVoUEQHA5/PZNM02y6qqMsb0w4CIwixziPO+6zqt9T7Py9PJeQ/OhRhV+3hkm02jdQhBiEKMZVkedrvlPZrNH237UhTEzIiUUkK8ns+6rtXb5SIir8ejruuJFIW+378XWyoJ4o/aiEykOIRpinHaEOFxnPh/WE5/AW/tWpkazh9dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Max Heap\" title=\"Max Heap\" src=\"/static/be0a11ae707f1a5968ed6d7e4217e3bf/c5bb3/max-heap.png\" srcset=\"/static/be0a11ae707f1a5968ed6d7e4217e3bf/04472/max-heap.png 170w,\n/static/be0a11ae707f1a5968ed6d7e4217e3bf/9f933/max-heap.png 340w,\n/static/be0a11ae707f1a5968ed6d7e4217e3bf/c5bb3/max-heap.png 680w,\n/static/be0a11ae707f1a5968ed6d7e4217e3bf/b12f7/max-heap.png 1020w,\n/static/be0a11ae707f1a5968ed6d7e4217e3bf/b5a09/max-heap.png 1360w,\n/static/be0a11ae707f1a5968ed6d7e4217e3bf/61583/max-heap.png 1616w\" sizes=\"(max-width: 680px) 100vw, 680px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n          </p>\n<div class=\"image-title\">Max Heap</div>\n<p>Since it's a binary tree, <strong>all parent nodes</strong> have <strong>at max 2 children</strong>. The binary tree is filled level by level from top to bottom, from left incomplete parent nodes (with none or one child) to right ones.</p>\n<p>With such a node positioning, we can come up with formulas for finding parent/children nodes:</p>\n<ul>\n<li><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi mathvariant=\"normal\">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mi mathvariant=\"normal\">/</mi><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">element\\_idx / 2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.06em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">/2</span></span></span></span></span> is the node parent index</li>\n<li><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>∗</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi mathvariant=\"normal\">_</mi><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">2 * element\\_idx</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span></span></span></span></span> is an index of the left child</li>\n<li><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>∗</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi mathvariant=\"normal\">_</mi><mi>i</mi><mi>d</mi><mi>x</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">2 * element\\_idx + 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span> is an index of the right child</li>\n</ul>\n<p>where <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi mathvariant=\"normal\">_</mi><mi>i</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">element\\_idx</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0044em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span></span></span></span></span> is some node index.</p>\n<p>Additionally, the binary tree has the following useful properties:</p>\n<ul>\n<li>Heigh of the tree is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><mi>n</mi><mo stretchy=\"false\">(</mo><mi>N</mi><mo stretchy=\"false\">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">ln(N) + 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span></li>\n</ul>\n<p>The \"nearly complete\" means that <strong>not all tree levels</strong> may be <strong>filled out</strong> by leaf nodes (nodes without children). In other words, we can have a heap with any number of items.</p>\n<p>The heap has a distinct property that actually makes it helpful:</p>\n<ul>\n<li>all children node values should be <strong>less or equal</strong> to the parent node value (<strong>the max-heap property</strong>)</li>\n<li>or all children node values should be <strong>greater or equal</strong> to the parent node value (<strong>the min-heap property</strong>)</li>\n</ul>\n<p>To explain how all of this can be useful, we are going to implement the main heap functions from scratch.</p>\n<h2 id=\"heap-building\" style=\"position:relative;\"><a href=\"#heap-building\" aria-label=\"heap building permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Heap Building</h2>\n<p>There is going to be a custom <code class=\"language-text\">PriorityQueue</code> class which takes an arbitrary array of integers, makes a heap from it and sustains the heap property during all operations.</p>\n<p>The first thing we need to do is to build a max heap from an unsorted array. We can already visualize the array as a heap, but it would <strong>luck the max heap property</strong>.</p>\n<p>Notice that <strong>leaf nodes can't violate the heap property</strong> since they don't have any child nodes. Hence, we can start looking at possible violations from the second-to-last level. The index of the last parent element on that level we can get via <code class=\"language-text\">n // 2</code> where <code class=\"language-text\">n</code> is the size of the array.</p>\n<p>We start moving from right to left, from the bottom to the top of the heap. For each parent node, we need to make sure that the property of the heap holds true. If there is any violations, we just switch the current parent node with a child node that is greater than it (which violates the heap property).</p>\n<p>However, this switching of the nodes may create a new violation on the levels below. So we need to perform the same procedure again for a node that became a child.</p>\n<p>\n\t\t<video\n\t\t\tsrc=/57048b8030e0ab8ba4571d2ab2920604/heapify.mp4\n\t\t\twidth=\"100%\"\n\t\t\theight=\"auto\"\n\t\t\tpreload=\"auto\"\n\t\t\tmuted=\"true\"\n\t\t\ttitle=\"Building a heap\"\n\t\t\tautoplay\n\t\t\tplaysinline\n\t\t\tcontrols\n\t\t\tloop\n\t\t></video>\n\t</p>\n<div class=\"image-title\">Max Heapifying</div>\n<p>Here is how this can be implemented:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> List\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PriorityQueue</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Represents the heap and preserves the heap property during adding/removing elements\n    \"\"\"</span>\n    items<span class=\"token punctuation\">:</span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> items<span class=\"token punctuation\">:</span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>build_heap<span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">build_heap</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> items<span class=\"token punctuation\">:</span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        Turn an unsorted array into a heap\n        \"\"\"</span>\n        items_count <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>items_count <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            items <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>heapify<span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> items\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">heapify</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> items<span class=\"token punctuation\">:</span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> node_idx<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> root_idx<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        Check and fix violations of the heap property recursively\n        \"\"\"</span>\n        items_count <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span>\n        largest_idx <span class=\"token operator\">=</span> node_idx\n\n        <span class=\"token comment\"># formulas for zero-indexed arrays</span>\n        left_child_idx <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>node_idx <span class=\"token operator\">-</span> root_idx<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> root_idx\n        right_child_idx <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>node_idx <span class=\"token operator\">-</span> root_idx<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> root_idx\n\n        <span class=\"token comment\"># is the left child node bigger than parent node?</span>\n        <span class=\"token keyword\">if</span> left_child_idx <span class=\"token operator\">&lt;</span> items_count <span class=\"token keyword\">and</span> items<span class=\"token punctuation\">[</span>left_child_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> items<span class=\"token punctuation\">[</span>largest_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n            largest_idx <span class=\"token operator\">=</span> left_child_idx\n\n        <span class=\"token comment\"># is the right child node bigger than parent or left node?</span>\n        <span class=\"token keyword\">if</span> right_child_idx <span class=\"token operator\">&lt;</span> items_count <span class=\"token keyword\">and</span> items<span class=\"token punctuation\">[</span>right_child_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> items<span class=\"token punctuation\">[</span>largest_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n            largest_idx <span class=\"token operator\">=</span> right_child_idx\n\n        <span class=\"token comment\"># let's fix a violation of the heap property</span>\n        <span class=\"token keyword\">if</span> largest_idx <span class=\"token operator\">!=</span> node_idx<span class=\"token punctuation\">:</span>\n            items<span class=\"token punctuation\">[</span>node_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> items<span class=\"token punctuation\">[</span>largest_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> items<span class=\"token punctuation\">[</span>largest_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> items<span class=\"token punctuation\">[</span>node_idx<span class=\"token punctuation\">]</span>\n\n            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>heapify<span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">,</span> largest_idx<span class=\"token punctuation\">,</span> root_idx<span class=\"token operator\">=</span>root_idx<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> items\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Complexity of this algorithm is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Θ</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Theta(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">Θ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span></span>. This is because we check each position only once making our way up the heap. All levels below the current one at each point of time are already satisfying the heap property. So there is no need to back them up.</p>\n<h2 id=\"adding-a-new-element\" style=\"position:relative;\"><a href=\"#adding-a-new-element\" aria-label=\"adding a new element permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Adding a New Element</h2>\n<p>Another useful method to have is adding a new item to the heap. In this case, it's convenient to add a new item as a leaf node in the end of the heap array. This makes sure there are no violations below it. However, there may be some going upward. That's why we need to go all the way up and check whenever parent nodes are greater than the new item. If they are not, we will switch their positions.</p>\n<p>Since the max heap property had stayed true before we add the new item, it's sufficient for us to check only parent nodes as we know that all child nodes should be less or equal to the parent value.</p>\n<p>\n\t\t<video\n\t\t\tsrc=/504273255cec707881a6d5ccbc3f91a9/insert-a-new-item-to-the-heap.mp4\n\t\t\twidth=\"100%\"\n\t\t\theight=\"auto\"\n\t\t\tpreload=\"auto\"\n\t\t\tmuted=\"true\"\n\t\t\ttitle=\"Insert a new item to the heap\"\n\t\t\tautoplay\n\t\t\tplaysinline\n\t\t\tcontrols\n\t\t\tloop\n\t\t></video>\n\t</p>\n<div class=\"image-title\">Insert a new item to the heap</div>\n<p>Now we can take a look at the implementation:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Add a new item to the heap preserving the heap property\n    \"\"\"</span>\n    self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span>\n\n    idx <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span>\n    parent_idx <span class=\"token operator\">=</span> idx <span class=\"token operator\">//</span> <span class=\"token number\">2</span>\n\n    <span class=\"token keyword\">if</span> idx <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># calculating parents in zero-indexed array</span>\n        parent_idx <span class=\"token operator\">-=</span> <span class=\"token number\">1</span>\n\n    <span class=\"token keyword\">while</span> idx <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token keyword\">and</span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>parent_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        tmp <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>parent_idx<span class=\"token punctuation\">]</span>\n        self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>parent_idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span>\n        self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> tmp\n\n        idx <span class=\"token operator\">=</span> parent_idx\n        parent_idx <span class=\"token operator\">=</span> idx <span class=\"token operator\">//</span> <span class=\"token number\">2</span>\n\n        <span class=\"token keyword\">if</span> idx <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># calculating parents in zero-indexed array</span>\n            parent_idx <span class=\"token operator\">-=</span> <span class=\"token number\">1</span></code></pre></div>\n<p>The complexity of heap inserting algorithm is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Θ</mi><mo stretchy=\"false\">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Theta(log(n))</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">Θ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">))</span></span></span></span></span> since at each interaction we traversal another tree level.</p>\n<h2 id=\"extracting-the-max-element\" style=\"position:relative;\"><a href=\"#extracting-the-max-element\" aria-label=\"extracting the max element permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Extracting The Max Element</h2>\n<p>The key method of the heap is extracting the max element. Because of the heap property, the max element should always stay that the top of the heap. So it's as simple as call <code class=\"language-text\">self.items[0]</code> to get it.</p>\n<p>That's not all. The extraction would remove the element from the heap and we can not just leave it with a \"hole\". Instead, we need to put the next max element there.</p>\n<p>Like before, the safest way is to <strong>replace the hole with the last leaf node</strong> (not to change the heap property in other branches of the heap). The last item is just handy to use, but it's not necessarily the next needed candidate to be at the top of the heap. To make sure, we need to run the <code class=\"language-text\">heapify()</code> method which recursively fixes all violations.</p>\n<p>\n\t\t<video\n\t\t\tsrc=/ac4d4e7e997ecd484aade4d0f2c10cb1/extract-max-element-from-the-heap.mp4\n\t\t\twidth=\"100%\"\n\t\t\theight=\"auto\"\n\t\t\tpreload=\"auto\"\n\t\t\tmuted=\"true\"\n\t\t\ttitle=\"Extract the max element from the heap\"\n\t\t\tautoplay\n\t\t\tplaysinline\n\t\t\tcontrols\n\t\t\tloop\n\t\t></video>\n\t</p>\n<div class=\"image-title\">Extract the max element from the heap</div>\n<p>The implementation is straightforward:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Extract the next item from the heap according to priority (the next biggest element in our max heap case)\n    \"\"\"</span>\n    item <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n\n    items_count <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span>\n    self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>items_count <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># replace extracted max element with one of the balanced leaves</span>\n    <span class=\"token keyword\">del</span> self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">[</span>items_count <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n\n    self<span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>heapify<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> item</code></pre></div>\n<p>The complexity of heap items extracting algorithm is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Θ</mi><mo stretchy=\"false\">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Theta(log(n))</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">Θ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">))</span></span></span></span></span>. Nevertheless, we can get access to the current max element in <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Θ</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Theta(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">Θ</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span></span>.</p>\n<h2 id=\"heap-sort\" style=\"position:relative;\"><a href=\"#heap-sort\" aria-label=\"heap sort permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Heap Sort</h2>\n<p>Now we have all components to implement one of the most frequent applications of the priority queue - the heap sorting.</p>\n<p>Heap sort is just the extraction of <code class=\"language-text\">n</code> elements from the heap.</p>\n<p>\n\t\t<video\n\t\t\tsrc=/c73facee0c9e850b4562b7b8c5b5cab8/heap-sort.mp4\n\t\t\twidth=\"100%\"\n\t\t\theight=\"auto\"\n\t\t\tpreload=\"auto\"\n\t\t\tmuted=\"true\"\n\t\t\ttitle=\"Heap Sort In Action\"\n\t\t\tautoplay\n\t\t\tplaysinline\n\t\t\tcontrols\n\t\t\tloop\n\t\t></video>\n\t</p>\n<div class=\"image-title\">Heap Sort In Action</div>\n<p>The simplest implementation of the heap source may look like this in Python:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">heap_sort</span><span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">:</span> PriorityQueue<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    items_count <span class=\"token operator\">=</span> heap<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>items_count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        result<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">.</span>pop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> result</code></pre></div>\n<p>The complexity of heap sorting is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Θ</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Theta(nlog(n))</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">Θ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">))</span></span></span></span></span>.</p>\n<p>It takes the additional memory to store another sorted copy of the array. However, we can do in-place sorting as well:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">sort</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    In-place version of the heap sort.\n    It breaks the heap property, so be aware of that.\n    \"\"\"</span>\n    items_count <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> items_count <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># find the next max element/restore the heap property</span>\n        items <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>heapify<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> root_idx<span class=\"token operator\">=</span>i<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>items</code></pre></div>\n<p>In this approach, we use the root node offset trick that helps us to change the position of the root node and move from the left to right sorting the <code class=\"language-text\">self.items</code> array. The <code class=\"language-text\">root_idx</code> param is just tweaks the child calculation formula for that.</p>\n<p>The cost of being in-place solution is breaking the heap property in <code class=\"language-text\">self.items</code> array. I would prefer the first version of the heap sort in order to avoid such a mutations to <code class=\"language-text\">self.items</code> array.</p>\n<h2 id=\"applications\" style=\"position:relative;\"><a href=\"#applications\" aria-label=\"applications permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Applications</h2>\n<p>Heap sorting is not the only application of the priority queue. Here are a few more cases where heaps are being applied:</p>\n<ul>\n<li>access to a limited resource like making sure your Zoom application has a high network bandwidth priority, hence, lower latency</li>\n<li>device interruption handling like pressing a key on the keyboard triggers a specific interruption handler that rads a key value and send it to the OS. There is an interruption latency associated with this process and interruptions from some devices we wish to be processed as soon as possible</li>\n<li>the heap can be used during searching for <a target=\"_blank\" rel=\"noopener\" href=\"/blog/k-nearest-neighbors/\">K-Nearest Neighbors</a></li>\n</ul>\n<p>Broadly speaking, the heap may be used everywhere where we need to keep track of the list of min or max elements that may be changed during the runtime.</p>\n<h2 id=\"heapq\" style=\"position:relative;\"><a href=\"#heapq\" aria-label=\"heapq permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>heapq</h2>\n<p>Thankfully, it's not required to implement the heap yourself everytime you need it. Python provides a library called <a target=\"_blank\" rel=\"noopener\" href=\"https://docs.python.org/3/library/heapq.html\">heapq</a> which is a set of functions that operates on the \"heapified\" array preserving the min-heap property.</p>\n<p>The min-heap sort can be implemented this way:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> heapq\n\nheap <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">36</span><span class=\"token punctuation\">]</span>\nheapq<span class=\"token punctuation\">.</span>heapify<span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">)</span>\n\nresult <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nn <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    result<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>heapq<span class=\"token punctuation\">.</span>heappop<span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"practice\" style=\"position:relative;\"><a href=\"#practice\" aria-label=\"practice permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Practice</h2>\n<ul>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://leetcode.com/problems/last-stone-weight/\">[Leetcode] 1046. Last Stone Weight</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://leetcode.com/problems/single-threaded-cpu/\">[Leetcode] 1834. Single-Threaded CPU</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://leetcode.com/problems/find-k-th-smallest-pair-distance/\">[Leetcode] 719. Find K-th Smallest Pair Distance</a></li>\n</ul>\n<h2 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Summary</h2>\n<p>In this article, we have reviewed how to implement a priority queue, what properties it has and how it can be helpful.</p>\n<p>If the heap concept was new for you, try to do a few problems from the practice section.</p>\n<p>Finally, let me know in the comments what unusual applications of heaps you have seen in your practice.</p>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg class=\"anchor-icon\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>References</h2>\n<ul>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://gist.github.com/roma-glushko/43678fcec904209adb276f33a56ce9de\">Source code on GitHub</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/lecture-videos/lecture-4-heaps-and-heap-sort/\">MIT 6.006 - Heaps and Heap Sort</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://visualgo.net/en/heap\">Heap Visualized</a></li>\n</ul>","timeToRead":9,"rawMarkdownBody":"\nWhen you have a sequence of candidates to process, then you build a queue to organize them. In the classical queue, the time of adding an item to the queue defines when it's going to be processed.\n\nWhat if we need to change this principle and use some **relative importance score** to determine the item processing sequence?\n\nWell, then we would reinvent ~~bicycle~~ the priority queue.\n\n`video: title: \"Priority\": https://media.giphy.com/media/3orif1K6QR54NlWzLO/giphy.mp4`\n\n**The priority queue or heap** is a data structure that efficiently allows the retrieval of the next queued item with min or max importance score.\n\n## Nearly Complete Binary Tree\n\nThe heap can be represented as an array or a list that is visualized as a nearly complete binary tree:\n\n![Max Heap](./img/max-heap.png \"Max Heap\")\n\n<div class=\"image-title\">Max Heap</div>\n\nSince it's a binary tree, **all parent nodes** have **at max 2 children**. The binary tree is filled level by level from top to bottom, from left incomplete parent nodes (with none or one child) to right ones.\n\nWith such a node positioning, we can come up with formulas for finding parent/children nodes:\n\n- $element\\_idx / 2$ is the node parent index\n- $2 * element\\_idx$ is an index of the left child\n- $2 * element\\_idx + 1$ is an index of the right child\n\nwhere $element\\_idx$ is some node index.\n\nAdditionally, the binary tree has the following useful properties:\n\n- Heigh of the tree is $ln(N) + 1$\n\nThe \"nearly complete\" means that **not all tree levels** may be **filled out** by leaf nodes (nodes without children). In other words, we can have a heap with any number of items.\n\nThe heap has a distinct property that actually makes it helpful:\n\n- all children node values should be **less or equal** to the parent node value (**the max-heap property**)\n- or all children node values should be **greater or equal** to the parent node value (**the min-heap property**)\n\nTo explain how all of this can be useful, we are going to implement the main heap functions from scratch.\n\n## Heap Building\n\nThere is going to be a custom `PriorityQueue` class which takes an arbitrary array of integers, makes a heap from it and sustains the heap property during all operations.\n\nThe first thing we need to do is to build a max heap from an unsorted array. We can already visualize the array as a heap, but it would **luck the max heap property**.\n\nNotice that **leaf nodes can't violate the heap property** since they don't have any child nodes. Hence, we can start looking at possible violations from the second-to-last level. The index of the last parent element on that level we can get via `n // 2` where `n` is the size of the array.\n\nWe start moving from right to left, from the bottom to the top of the heap. For each parent node, we need to make sure that the property of the heap holds true. If there is any violations, we just switch the current parent node with a child node that is greater than it (which violates the heap property).\n\nHowever, this switching of the nodes may create a new violation on the levels below. So we need to perform the same procedure again for a node that became a child.\n\n`video: title: \"Building a heap\": ./img/heapify.mp4`\n\n<div class=\"image-title\">Max Heapifying</div>\n\nHere is how this can be implemented:\n\n```python\nfrom typing import List\n\n\nclass PriorityQueue:\n    \"\"\"\n    Represents the heap and preserves the heap property during adding/removing elements\n    \"\"\"\n    items: List[int]\n\n    def __init__(self, items: List[int]):\n        self.items = self.build_heap(items)\n\n    def build_heap(self, items: List[int]) -> List[int]:\n        \"\"\"\n        Turn an unsorted array into a heap\n        \"\"\"\n        items_count = len(items)\n\n        for i in range(items_count // 2, -1, -1):\n            items = self.heapify(items, i)\n\n        return items\n\n    def heapify(self, items: List[int], node_idx: int, root_idx: int = 0) -> List[int]:\n        \"\"\"\n        Check and fix violations of the heap property recursively\n        \"\"\"\n        items_count = len(items)\n        largest_idx = node_idx\n\n        # formulas for zero-indexed arrays\n        left_child_idx = 2 * (node_idx - root_idx) + 1 + root_idx\n        right_child_idx = 2 * (node_idx - root_idx) + 2 + root_idx\n\n        # is the left child node bigger than parent node?\n        if left_child_idx < items_count and items[left_child_idx] > items[largest_idx]:\n            largest_idx = left_child_idx\n\n        # is the right child node bigger than parent or left node?\n        if right_child_idx < items_count and items[right_child_idx] > items[largest_idx]:\n            largest_idx = right_child_idx\n\n        # let's fix a violation of the heap property\n        if largest_idx != node_idx:\n            items[node_idx], items[largest_idx] = items[largest_idx], items[node_idx]\n\n            return self.heapify(items, largest_idx, root_idx=root_idx)\n\n        return items\n\n    def size(self) -> int:\n        return len(self.items)\n```\n\nComplexity of this algorithm is $\\Theta(n)$. This is because we check each position only once making our way up the heap. All levels below the current one at each point of time are already satisfying the heap property. So there is no need to back them up.\n\n## Adding a New Element\n\nAnother useful method to have is adding a new item to the heap. In this case, it's convenient to add a new item as a leaf node in the end of the heap array. This makes sure there are no violations below it. However, there may be some going upward. That's why we need to go all the way up and check whenever parent nodes are greater than the new item. If they are not, we will switch their positions.\n\nSince the max heap property had stayed true before we add the new item, it's sufficient for us to check only parent nodes as we know that all child nodes should be less or equal to the parent value.\n\n`video: title: \"Insert a new item to the heap\": ./img/insert-a-new-item-to-the-heap.mp4`\n\n<div class=\"image-title\">Insert a new item to the heap</div>\n\nNow we can take a look at the implementation:\n\n```python\ndef push(self, item: int):\n    \"\"\"\n    Add a new item to the heap preserving the heap property\n    \"\"\"\n    self.items.append(item)\n\n    idx = len(self.items) - 1\n    parent_idx = idx // 2\n\n    if idx % 2 == 0:\n        # calculating parents in zero-indexed array\n        parent_idx -= 1\n\n    while idx > 0 and self.items[idx] > self.items[parent_idx]:\n        tmp = self.items[parent_idx]\n        self.items[parent_idx] = self.items[idx]\n        self.items[idx] = tmp\n\n        idx = parent_idx\n        parent_idx = idx // 2\n\n        if idx % 2 == 0:\n            # calculating parents in zero-indexed array\n            parent_idx -= 1\n```\n\nThe complexity of heap inserting algorithm is $\\Theta(log(n))$ since at each interaction we traversal another tree level.\n\n## Extracting The Max Element\n\nThe key method of the heap is extracting the max element. Because of the heap property, the max element should always stay that the top of the heap. So it's as simple as call `self.items[0]` to get it.\n\nThat's not all. The extraction would remove the element from the heap and we can not just leave it with a \"hole\". Instead, we need to put the next max element there.\n\nLike before, the safest way is to **replace the hole with the last leaf node** (not to change the heap property in other branches of the heap). The last item is just handy to use, but it's not necessarily the next needed candidate to be at the top of the heap. To make sure, we need to run the `heapify()` method which recursively fixes all violations.\n\n`video: title: \"Extract the max element from the heap\": ./img/extract-max-element-from-the-heap.mp4`\n\n<div class=\"image-title\">Extract the max element from the heap</div>\n\nThe implementation is straightforward:\n\n```python\ndef pop(self):\n    \"\"\"\n    Extract the next item from the heap according to priority (the next biggest element in our max heap case)\n    \"\"\"\n    item = self.items[0]\n\n    items_count = len(self.items)\n    self.items[0] = self.items[items_count - 1]  # replace extracted max element with one of the balanced leaves\n    del self.items[items_count - 1]\n\n    self.items = self.heapify(self.items, 0)\n\n    return item\n```\n\nThe complexity of heap items extracting algorithm is $\\Theta(log(n))$. Nevertheless, we can get access to the current max element in $\\Theta(1)$.\n\n## Heap Sort\n\nNow we have all components to implement one of the most frequent applications of the priority queue - the heap sorting.\n\nHeap sort is just the extraction of `n` elements from the heap.\n\n`video: title: \"Heap Sort In Action\": ./img/heap-sort.mp4`\n\n<div class=\"image-title\">Heap Sort In Action</div>\n\nThe simplest implementation of the heap source may look like this in Python:\n\n```python\ndef heap_sort(heap: PriorityQueue) -> List[int]:\n    items_count = heap.size()\n\n    result = []\n\n    for i in range(items_count):\n        result.append(heap.pop())\n\n    return result\n```\n\nThe complexity of heap sorting is $\\Theta(nlog(n))$.\n\nIt takes the additional memory to store another sorted copy of the array. However, we can do in-place sorting as well:\n\n```python\ndef sort(self) -> List[int]:\n    \"\"\"\n    In-place version of the heap sort.\n    It breaks the heap property, so be aware of that.\n    \"\"\"\n    items_count = self.size()\n\n    for i in range(1, items_count - 1):\n        # find the next max element/restore the heap property\n        items = self.heapify(self.items, i, root_idx=i)\n\n    return self.items\n```\n\nIn this approach, we use the root node offset trick that helps us to change the position of the root node and move from the left to right sorting the `self.items` array. The `root_idx` param is just tweaks the child calculation formula for that.\n\nThe cost of being in-place solution is breaking the heap property in `self.items` array. I would prefer the first version of the heap sort in order to avoid such a mutations to `self.items` array.\n\n## Applications\n\nHeap sorting is not the only application of the priority queue. Here are a few more cases where heaps are being applied:\n\n- access to a limited resource like making sure your Zoom application has a high network bandwidth priority, hence, lower latency\n- device interruption handling like pressing a key on the keyboard triggers a specific interruption handler that rads a key value and send it to the OS. There is an interruption latency associated with this process and interruptions from some devices we wish to be processed as soon as possible\n- the heap can be used during searching for <a target=\"_blank\" rel=\"noopener\" href=\"/blog/k-nearest-neighbors/\">K-Nearest Neighbors</a>\n\nBroadly speaking, the heap may be used everywhere where we need to keep track of the list of min or max elements that may be changed during the runtime.\n\n## heapq\n\nThankfully, it's not required to implement the heap yourself everytime you need it. Python provides a library called <a target=\"_blank\" rel=\"noopener\" href=\"https://docs.python.org/3/library/heapq.html\">heapq</a> which is a set of functions that operates on the \"heapified\" array preserving the min-heap property.\n\nThe min-heap sort can be implemented this way:\n\n```python\nimport heapq\n\nheap = [2, 7, 26, 25, 19, 17, 1, 90, 3, 36]\nheapq.heapify(heap)\n\nresult = []\nn = len(heap)\n\nfor i in range(n):\n    result.append(heapq.heappop(heap))\n```\n\n## Practice\n\n- <a target=\"_blank\" rel=\"noopener\" href=\"https://leetcode.com/problems/last-stone-weight/\">[Leetcode] 1046. Last Stone Weight</a>\n- <a target=\"_blank\" rel=\"noopener\" href=\"https://leetcode.com/problems/single-threaded-cpu/\">[Leetcode] 1834. Single-Threaded CPU</a>\n- <a target=\"_blank\" rel=\"noopener\" href=\"https://leetcode.com/problems/find-k-th-smallest-pair-distance/\">[Leetcode] 719. Find K-th Smallest Pair Distance</a>\n\n## Summary\n\nIn this article, we have reviewed how to implement a priority queue, what properties it has and how it can be helpful.\n\nIf the heap concept was new for you, try to do a few problems from the practice section.\n\nFinally, let me know in the comments what unusual applications of heaps you have seen in your practice.\n\n## References\n\n- <a target=\"_blank\" rel=\"noopener\" href=\"https://gist.github.com/roma-glushko/43678fcec904209adb276f33a56ce9de\">Source code on GitHub</a>\n- <a target=\"_blank\" rel=\"noopener\" href=\"https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/lecture-videos/lecture-4-heaps-and-heap-sort/\">MIT 6.006 - Heaps and Heap Sort</a>\n- <a target=\"_blank\" rel=\"noopener\" href=\"https://visualgo.net/en/heap\">Heap Visualized</a>\n","wordCount":{"words":1307},"frontmatter":{"id":"62b87a6b15e35cd77d0d0dfd","path":"/blog/heapify/","humanDate":"May 16, 2021","fullDate":"2021-05-16","title":"Heapify ✌️","keywords":["algorithmic coding","data structures","python"],"excerpt":"How the priority queue and heap work: theory, implementation, complexity. Heap sorting and other applications.","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUDBAb/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAABgG1UkpoRP//EABsQAQACAgMAAAAAAAAAAAAAAAIBAwARFCMx/9oACAEBAAEFAuPZo0o460V4bp7JU5//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPwGH/8QAHRAAAQQCAwAAAAAAAAAAAAAAAQACEBEhIjGhsf/aAAgBAQAGPwIU3tbt5wFRBho9j//EABsQAAMBAAMBAAAAAAAAAAAAAAABESExQWFx/9oACAEBAAE/IW2BUGWV5Dppi+HYQiT2X0KPD//aAAwDAQACAAMAAAAQoN//xAAXEQADAQAAAAAAAAAAAAAAAAABEBEh/9oACAEDAQE/ELTq/8QAFhEBAQEAAAAAAAAAAAAAAAAAAREQ/9oACAECAQE/ECCGf//EABoQAQADAQEBAAAAAAAAAAAAAAEAETFRIUH/2gAIAQEAAT8QqICmcj0oKg0HWu5GB2tMCuy79i3JCAvzUqaArk//2Q=="},"images":{"fallback":{"src":"/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/5267c/markus-spiske-IiEFmIXZWSw-unsplash-min.jpg","srcSet":"/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/7284f/markus-spiske-IiEFmIXZWSw-unsplash-min.jpg 750w,\n/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/29ba9/markus-spiske-IiEFmIXZWSw-unsplash-min.jpg 1080w,\n/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/c8896/markus-spiske-IiEFmIXZWSw-unsplash-min.jpg 1366w,\n/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/5267c/markus-spiske-IiEFmIXZWSw-unsplash-min.jpg 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/57584/markus-spiske-IiEFmIXZWSw-unsplash-min.webp 750w,\n/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/984df/markus-spiske-IiEFmIXZWSw-unsplash-min.webp 1080w,\n/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/4a276/markus-spiske-IiEFmIXZWSw-unsplash-min.webp 1366w,\n/static/20fe662fa316fc9e5d4b4c6eaeaf84f6/9c00f/markus-spiske-IiEFmIXZWSw-unsplash-min.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}},"coverCredits":"Photo by <a href=\"https://unsplash.com/@markusspiske\">Markus Spiske</a> on <a href=\"https://unsplash.com/\">Unsplash</a>"}}},"pageContext":{"prevThought":{"frontmatter":{"path":"/blog/design-lru-cache/","title":"Design LRU Cache"}},"nextThought":{"frontmatter":{"path":"/blog/how-i-built-my-ml-workstation/","title":"How I built my ML workstation 🔬"}}}},"staticQueryHashes":["1271460761","2758069760"]}